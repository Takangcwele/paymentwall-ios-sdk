# Core SDK Integration Instruction
---------------------
## Step 1: Add Core SDK

Our SDK is delivered as static library or public repository.

>Note: If your CoreSDK got updated, you should also check to update the rest of plugins.

### Install with Cocoapods:

1. Install CocoaPods 0.39.0 or later
2. In your Podfile, add `pod 'PWCoreSDK'` and `pod 'PW[Local payment method]Plugin'`(optional) to your main and test targets
3. From the command line, run `pod install`
4. Use the .xcworkspace file generated by CocoaPods
5. Make sure you have `-ObjC` in `Other Linker Flags` in your project's Build settings
6. If you are using Swift, create a new Objective-C file in order to create new `bridging-header.h` files, then import the following files into the header file like:
```objective-c
#import <PWCoreSDK/PWCoreSDK.h>
```

### Install as Static library:

1. Download the latest release of the SDK and extract the zip.
2. Go to your Xcode project’s ```General``` settings. Drag ```libPWCoreSDK.a``` and other plugin library to the “Linked frameworks and libraries” section under your project directory. Make sure to copy items which are selected and click ```Finish```.
3. In your unit test target’s “Build Settings”, add the parent path to ```libPWCoreSDK.a``` in the ```Library Search Paths``` section.
4. Drag the bundle into your ```Copy bundle resources``` in project's ```Build phase```
5. Add `-ObjC` to `Other Linker Flags` in your project's Build settings
6. If you are using Swift, create a new Objective-C file in order to create new `bridging-header.h` files, then import the following files into the header file like:
```objective-c
#import <PWCoreSDK/PWCoreSDK.h>
```

## Step 2: Setup Core SDK

```swift
PWCoreSDK.sharedInstance().setupPaymentwall(withProjectKey: "YOUR PUBLIC KEY", secretKey: "YOUR SECRET KEY", requestTimeout: 30, clearPaymentMethodsAfterFinish: false)
```
>Project key: All payment option will use this Project key if their Project key set to nil, you also can specify their own Project key

>Secret key: PWLocal and local payment options plugins will use this Secret key as default if you specify it here

## Step 3: Extra Settings (Optional)
- `clearPaymentMethodsAfterFinish`: set to true if you wish to remove payment system, which are already added, after the SDK view controller is closed. You will have to add the payment system again, but the UI setting will be kept.
- Default UI of the SDK is flat style, to use game UI, check [PWGameUIPlugin](https://github.com/paymentwall/paymentwall-ios-sdk/tree/master/Plugins/PWGameUIPlugin)
- By default (except Brick), all payments method will show success once the payment is finish, if you don't want to use the SDK's success dialog but return delegate for you to work with, add this to your code: `PWCoreSDK.sharedInstance().setUseNativeFinishDialogForAllMethods(false)`
- To show bank processor address for Brick, use `PWCoreSDK.sharedInstance().setShowBrickFooter(true)`
- To use custom icon for local payments, use `PWCoreSDK.sharedInstance().setCustomLocalPaymentImage(image)`


## Step 4: Add Payment Methods
You can choose one or more payment methods according to your needs.

* [Brick](#brick)
* [PWLocal](#pwlocal)
* [Mint](#mint)
* [Mobiamo](#mobiamo)
* [External payment methods](#external-payment-methods)

## Step 5: Build Unified Payment Params

Create new payment with `PaymentObject` class and assign to the CoreSDK:
```swift
let payment = PaymentObject()
payment.name = choosenItem.name
payment.price = Double(choosenItem.price)!
payment.currency = "USD"
payment.image = choosenItem.image
payment.userID = "test_user"
payment.itemID = choosenItem.name+"id"
payment.signVersion = 3

let customSetting = ["widget":"pw",
                    "ag_type":"fixed"]
payment.pwLocalParams = customSetting

PWCoreSDK.sharedInstance().setPaymentObject(payment)
```

>Note: pwLocalParams can be Dictionary or any of the defined class: `CartDefaultWidget`, `DigitalGoodsDefaultWidget`, `DigitalGoodsFlexibleWidget`, `VirtualCurrency`, refer their headers for required property or [PWLocal docs](https://github.com/paymentwall/paymentwall-pwlocal-ios). Key and value like prices, amount, currencyCode, currencies, ag_name, ag_external_id, uid will be ignored and use the one you described in `PaymentObject`

## Step 6: Present View Controller
Present Payment options view controller:

```swift
PWCoreSDK.showPaymentOptionsViewController(withParentViewcontroller: self, delegate: self, showCompletion: nil)
```
## Step 7: Handle callback URL
Add this code in your AppDelegate  to handle callback from other app if you use plugins (suchs as Alipay, Unionpay, Paypal,...)
```swift
func application(_ app: UIApplication, open url: URL, options:[UIApplicationOpenURLOptionsKey : Any] = [:]) -> Bool {
    PWCoreSDK.sharedInstance().handleOpen(url)
    return true
}
```

## Step 8: Handle Payment Response
 Implement `PWCoreSDKDelegate` protocol to handle payment response:

```swift
func paymentResponse(_ response: PWCoreSDKResponse?) {
    guard let response = response else { return }
    switch response.responseCode {
        case .SUCCESSFUL:
        case .FAILED:
        case .CANCEL:
        case .MERCHANT_PROCESSING:
        //Example when you use Brick and `useNativeFinishDialog == true` can be found below
    }

    switch response.paymentType {
        case .NONE:
        case .MINT:
        case .PWLOCAL:
        case .BRICK:
        case .MOBIAMO:
        case .OTHERS:
    }
}
```
## Step 9: Customized UI
Usage:
```swift
let custom = PWCustomization()
//Config properties
PWCoreSDK.sharedInstance().setUseCustomization(custom)
```

- `UIBarStyle barStyle`: Change the status bar style

- `NSDictionary* infoCardTextAttribute`: You can set custom font and color of infoCard text with this property eg. item name and item value
- `UIColor* infoCardBackgroundColor`: Background color for the infoCard, default is 0xFFFFFF
- `UIImage* infoCardImage`: Replace the infoCard background with your own image, default is nil
- `UIViewContentMode infoCardImageMode`: Image content mode for infoCard background, default is UIViewContentModeScaleAspectFill

- `UIColor* headerBackgroundColor`: Change the header color, default is 0xFBBD30
- `UIImage* headerBackgroundImage`: Add image to the header view, default is nil
- `UIViewContentMode headerBackgroundImageMode`: Image content mode for header background, default is UIViewContentModeScaleAspectFill

- `UIColor* optionTextColor`: Set color for the text in option method background, does not affect cell, default is 0x000000
- `UIColor* optionBackgroundColor`: Background color for the whole view
- `UIImage* optionBackgroundImage`: Set image as background for the whole view, you can set alpha = 0 color for `headerBackgroundColor` to show whole image, default is nil
- `UIViewContentMode optionBackgroundImageMode`: Image content mode for view background image, default is UIViewContentModeScaleAspectFill

- `UIButton* buttonConfig`: Set custom UI property for this property to change some button to your liking, eg. backgroundColor, tintColor, titleColor, image

![customization_guide](https://user-images.githubusercontent.com/23113471/27816093-84af641a-60b3-11e7-9a8b-d2dd01a3eafc.png)

# Payment Methods Integration Details
## Brick
**Step 1: Add Brick to Core SDK**

```swift
PWCoreSDK.sharedInstance().addBrickPayment(withPublicKey: nil, useNativeFinishDialog: true, cardScannerPlugin: PWCardScannerPlugin.sharedInstance())
```
> If `useNativeFinishDialog` is set to `false`, the SDK will dismiss after token is successfully fetched, the `response.responseCode` will also be `.MERCHANT_PROCESSING`, you will have to handle success/failed/3D secure by yourself and store card feature won't be available

>If `useNativeFinishDialog` is set to `true`, the loading popup will keep showing, after you process the token in your sever, post a `Notification` to use the SDK success or failed dialog, also the SDK will call delegate again to return `.SUCCESS` or `.FAILED`


**Step 2: Handle One Time Token**

One-time token is automatically obtained by the SDK. After the token is successfully fetched, the `response: PWCoreSDKResponse` will contain the `token: BrickToken` along with it.

**Step 3: Create A Charge**

After obtaining one-time token, send a request from backend to Paymentwall server to create a charge.

POST request to: https://api.paymentwall.com/api/brick/charge

Parameters and description can be referred [here](https://paymentwall.github.io/apis#section-brick-charge).

**Step 4: Handle Charge Response**

```swift
if response.paymentType == .BRICK {
    if let returnedToken = response.token {
        //Process the token with your server here asynchronous
        //When done:
        NotificationCenter.default.post(name: Notification.Name(BRICK_TOKEN_PROCESSED_FINISH), object: nil, userInfo: nil)
    }
}
```
- Pass the error in Dictionary as `["error": errorMessage]` via `userInfo`, the SDK will automatically show failed dialog instead of successful dialog

- If 3D secure is necessary, pass the URL in Dictionary as `["secure": urlString]` via `userInfo`, the SDK will automatically show the 3D secure page and pass `SUCCESS/FAILED` back to app after user finishes entering secure info

- If you want to enable store card feature for user, pass the Charge object to our SDK via `userInfo`, Charge object format can be found in our [Brick docs](https://www.paymentwall.com/en/documentation/Brick/2968)


## PwLocal

**Step 1: Add PwLocal**

```swift
PWCoreSDK.sharedInstance().addPWLocalPayment(with: .DIGITAL_GOODS_FLEXIBLE, secretKey: nil)
```
> Value for `type`: VIRTUAL_CURRENCY / DIGITAL_GOODS_FLEXIBLE / DIGITAL_GOODS_DEFAULT / CART

**Step 2:Signature Calculation**

If you wish to provide your PWLocal signature manually:

```swift
//Define all params in step 8., and extra custom settings, then get `stringToSign`:

let payment = PaymentObject()
payment.name = choosenItem.name
payment.price = Double(choosenItem.price)!
payment.currency = "USD"
payment.image = choosenItem.image
payment.userID = "test_user"
payment.itemID = choosenItem.name+"id"
payment.signVersion = 3
let customSetting = ["widget":"pw",
                    "ag_type":"fixed"]

let strToSign = PWCoreSDK.sharedInstance().getStringToSign(customSetting, paymentObject: payment)

//Calculate your sign and set it
customSetting["sign"] = sha256(text: "\(strToSign!)YOUR SECRET KEY")
payment.pwLocalParams = customSetting
```

## Mint

**Add Mint**

```swift
PWCoreSDK.sharedInstance().addMintPayment(withAppID: nil)
```

## Mobiamo

**Add Mobiamo**

```swift
PWCoreSDK.sharedInstance().addMobiamoPayment(withAppID: nil, noPrice: true)
```
> If `noPrice` is set to `true`: Default Mobiamo price points will be used for each country.

> If `noPrice` is omitted: The price will be shown as you set in SDK.

## External Payment Methods

Paymentwall SDK supports external payment system injection (which are in our defined payment system (PS) list). Each time you want to add a new payment system, you have to include its native SDK into your project along with our plugin framework. Our framework will handle creating all the necessary parameters then you can use them to show the native local payment SDK:

**Step 1: Add Payment options to Core SDK**

```swift
PWCoreSDK.sharedInstance().addCustomPaymentOptions([alipay, unionpay, ...])
```
>Note: These payment options will be placed in `Local payments` together with PWLocal.

**Step 2: Import Plugin SDK**

Add the plugin by Cocoapods with `pod 'PW[Local payment method]Plugin'` or manually drag the `PW[Local payment method]Plugin.a` and its headers file to your project.

**Step 3: Import Header File**

Import the library header into your project or via `bridging-headers.h` if you use Swift

**Step 4: Set Up Plugin**

Each plugin has different requirements. Details can be found in their headers or detailed docs below.

>Note: All plugins support your own signature string if you don't specify Secret key in both CoreSDK and PluginSDK. Use `plugin.getStringToSign()` to get the string to sign, then add your signed string to `plugin.signString`
